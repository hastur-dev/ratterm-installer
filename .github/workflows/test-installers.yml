# GitHub Actions workflow for testing install scripts on all platforms
# Tests install-{os} and run-{os} scripts on Windows, Linux, and macOS

name: Test Install Scripts

on:
  push:
    branches: [main, develop]
    paths:
      - 'vim/**'
      - 'docker/**'
      - '.github/workflows/test-installers.yml'
  pull_request:
    branches: [main]
    paths:
      - 'vim/**'
      - 'docker/**'
      - '.github/workflows/test-installers.yml'
  workflow_dispatch:

env:
  # Bounded retry constants
  MAX_RETRIES: 3
  RETRY_DELAY: 5

jobs:
  # ============================================
  # Script Syntax Validation (runs on all PRs)
  # ============================================
  validate-scripts:
    name: Validate Script Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate shell scripts (shellcheck)
        run: |
          set -euo pipefail
          echo "Installing shellcheck..."
          sudo apt-get update && sudo apt-get install -y shellcheck

          echo "Validating shell scripts..."
          SCRIPTS_FOUND=0
          MAX_SCRIPTS=100

          for script in vim/*.sh; do
            if [ -f "$script" ]; then
              ((SCRIPTS_FOUND++)) || true
              if [ $SCRIPTS_FOUND -gt $MAX_SCRIPTS ]; then
                echo "ERROR: Too many scripts"
                exit 1
              fi
              echo "Checking: $script"
              shellcheck -x "$script" || echo "Warning: shellcheck issues in $script"
            fi
          done

          echo "Validated $SCRIPTS_FOUND shell scripts"

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $maxScripts = 100
          $scriptsFound = 0

          Get-ChildItem -Path "vim/*.ps1" -ErrorAction SilentlyContinue | ForEach-Object {
            $scriptsFound++
            if ($scriptsFound -gt $maxScripts) {
              throw "Too many scripts"
            }

            Write-Host "Parsing: $($_.Name)"
            $errors = $null
            $null = [System.Management.Automation.Language.Parser]::ParseFile(
              $_.FullName,
              [ref]$null,
              [ref]$errors
            )

            if ($errors.Count -gt 0) {
              Write-Error "Syntax errors in $($_.Name): $errors"
              exit 1
            }
          }

          Write-Host "Validated $scriptsFound PowerShell scripts"

  # ============================================
  # Linux Testing (Docker-based)
  # ============================================
  test-linux:
    name: Test Linux Install
    runs-on: ubuntu-latest
    needs: validate-scripts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux Docker image
        run: |
          set -euo pipefail
          echo "Building install-linux Docker image..."
          docker build -f docker/Dockerfile.linux -t install-linux .

      - name: Run install script in container
        run: |
          set -euo pipefail
          echo "Running install-linux.sh..."
          docker run --rm install-linux /bin/bash -c "/app/vim/install-linux.sh"

      - name: Run verification script in container
        run: |
          set -euo pipefail
          echo "Running run-linux.sh to verify installation..."
          docker run --rm install-linux /bin/bash -c "/app/vim/install-linux.sh && /app/vim/run-linux.sh"

  # ============================================
  # macOS Testing (Native runner)
  # ============================================
  test-macos:
    name: Test macOS Install
    runs-on: macos-latest
    needs: validate-scripts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x vim/install-macos.sh
          chmod +x vim/run-macos.sh

      - name: Run install script
        run: |
          set -euo pipefail
          echo "Running install-macos.sh..."
          ./vim/install-macos.sh

      - name: Run verification script
        run: |
          set -euo pipefail
          echo "Running run-macos.sh to verify installation..."
          ./vim/run-macos.sh

  # ============================================
  # Windows Testing (Native runner)
  # ============================================
  test-windows:
    name: Test Windows Install
    runs-on: windows-latest
    needs: validate-scripts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run install script
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          Write-Host "Running install-windows.ps1..."
          & .\vim\install-windows.ps1

      - name: Run verification script
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          Write-Host "Running run-windows.ps1 to verify installation..."
          & .\vim\run-windows.ps1

  # ============================================
  # Docker Build Test (all Dockerfiles)
  # ============================================
  test-docker-builds:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    needs: validate-scripts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build all Docker images
        run: |
          set -euo pipefail

          MAX_DOCKERFILES=10
          DOCKERFILE_COUNT=0

          for dockerfile in docker/Dockerfile.*; do
            if [ -f "$dockerfile" ]; then
              ((DOCKERFILE_COUNT++)) || true
              if [ $DOCKERFILE_COUNT -gt $MAX_DOCKERFILES ]; then
                echo "ERROR: Too many Dockerfiles"
                exit 1
              fi

              # Extract OS name from Dockerfile.{os}
              os_name="${dockerfile##*.}"
              image_name="install-${os_name}"

              echo "Building: ${image_name} from ${dockerfile}"
              docker build -f "$dockerfile" -t "$image_name" .

              echo "Testing: ${image_name}"
              docker run --rm "$image_name" echo "Container started successfully"
            fi
          done

          echo "Built and tested $DOCKERFILE_COUNT Docker images"

  # ============================================
  # Integration Summary
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-linux, test-macos, test-windows, test-docker-builds]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "========================================="
          echo "Test Results Summary"
          echo "========================================="

          FAILED=0

          if [ "${{ needs.test-linux.result }}" != "success" ]; then
            echo "❌ Linux tests: ${{ needs.test-linux.result }}"
            FAILED=1
          else
            echo "✅ Linux tests: passed"
          fi

          if [ "${{ needs.test-macos.result }}" != "success" ]; then
            echo "❌ macOS tests: ${{ needs.test-macos.result }}"
            FAILED=1
          else
            echo "✅ macOS tests: passed"
          fi

          if [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "❌ Windows tests: ${{ needs.test-windows.result }}"
            FAILED=1
          else
            echo "✅ Windows tests: passed"
          fi

          if [ "${{ needs.test-docker-builds.result }}" != "success" ]; then
            echo "❌ Docker builds: ${{ needs.test-docker-builds.result }}"
            FAILED=1
          else
            echo "✅ Docker builds: passed"
          fi

          echo "========================================="

          if [ $FAILED -eq 1 ]; then
            echo "Some tests failed!"
            exit 1
          fi

          echo "All tests passed!"
