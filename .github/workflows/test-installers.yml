# GitHub Actions workflow for testing install scripts on all platforms
# Required status check for branch protection on main
# Tests install-{os}, run-{os}, and uninstall-{os} scripts

name: Test Install Scripts

on:
  # Run on pull requests from dev to main
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

  # Manual trigger for testing on any branch
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run tests on'
        required: false
        default: 'dev'
        type: string

env:
  MAX_RETRIES: 3
  RETRY_DELAY: 5

jobs:
  # ============================================
  # Script Syntax Validation
  # ============================================
  validate-scripts:
    name: Validate Script Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate shell scripts (shellcheck)
        run: |
          set -euo pipefail
          echo "Installing shellcheck..."
          sudo apt-get update && sudo apt-get install -y shellcheck

          echo "Validating shell scripts..."
          SCRIPTS_FOUND=0
          MAX_SCRIPTS=100

          # Find all .sh files in application directories
          for script in scripts/*/install-*.sh scripts/*/run-*.sh scripts/*/uninstall-*.sh; do
            if [ -f "$script" ]; then
              ((SCRIPTS_FOUND++)) || true
              if [ $SCRIPTS_FOUND -gt $MAX_SCRIPTS ]; then
                echo "ERROR: Too many scripts"
                exit 1
              fi
              echo "Checking: $script"
              shellcheck -x "$script" || echo "Warning: shellcheck issues in $script"
            fi
          done

          echo "Validated $SCRIPTS_FOUND shell scripts"

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $maxScripts = 100
          $scriptsFound = 0

          # Find all .ps1 files in application directories
          $patterns = @("scripts/*/install-*.ps1", "scripts/*/run-*.ps1", "scripts/*/uninstall-*.ps1")
          foreach ($pattern in $patterns) {
            Get-ChildItem -Path $pattern -ErrorAction SilentlyContinue | ForEach-Object {
              $scriptsFound++
              if ($scriptsFound -gt $maxScripts) {
                throw "Too many scripts"
              }

              Write-Host "Parsing: $($_.FullName)"
              $errors = $null
              $null = [System.Management.Automation.Language.Parser]::ParseFile(
                $_.FullName,
                [ref]$null,
                [ref]$errors
              )

              if ($errors.Count -gt 0) {
                Write-Error "Syntax errors in $($_.Name): $errors"
                exit 1
              }
            }
          }

          Write-Host "Validated $scriptsFound PowerShell scripts"

  # ============================================
  # Linux Testing (Docker-based) - All Technologies
  # ============================================
  test-linux:
    name: Test Linux - ${{ matrix.technology }}
    runs-on: ubuntu-latest
    needs: validate-scripts
    strategy:
      fail-fast: false
      matrix:
        # Note: gpustat excluded - requires NVIDIA GPU not available in CI
        technology: [vim, emacs, python, npm, javascript, rust]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux Docker image
        run: |
          set -euo pipefail
          echo "Building install-linux Docker image..."
          docker build -f docker/Dockerfile.linux -t install-linux .

      - name: Run install and verify scripts
        run: |
          set -euo pipefail
          TECH="${{ matrix.technology }}"
          echo "Testing $TECH on Linux..."
          docker run --rm install-linux /bin/bash -c "/app/scripts/$TECH/install-linux.sh && /app/scripts/$TECH/run-linux.sh"

  # ============================================
  # macOS Testing (Native runner) - All Technologies
  # ============================================
  test-macos:
    name: Test macOS - ${{ matrix.technology }}
    runs-on: macos-latest
    needs: validate-scripts
    strategy:
      fail-fast: false
      matrix:
        # Note: gpustat excluded - requires NVIDIA GPU not available in CI
        technology: [vim, emacs, python, npm, javascript, rust]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x scripts/${{ matrix.technology }}/install-macos.sh
          chmod +x scripts/${{ matrix.technology }}/run-macos.sh

      - name: Run install and verify scripts
        run: |
          set -euo pipefail
          TECH="${{ matrix.technology }}"
          echo "Testing $TECH on macOS..."
          ./scripts/$TECH/install-macos.sh
          ./scripts/$TECH/run-macos.sh

  # ============================================
  # Windows Testing (Native runner) - All Technologies
  # ============================================
  test-windows:
    name: Test Windows - ${{ matrix.technology }}
    runs-on: windows-latest
    needs: validate-scripts
    strategy:
      fail-fast: false
      matrix:
        # Note: gpustat excluded - requires NVIDIA GPU not available in CI
        technology: [vim, emacs, python, npm, javascript, rust]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run install and verify scripts
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $tech = "${{ matrix.technology }}"
          Write-Host "Testing $tech on Windows..."
          & ".\scripts\$tech\install-windows.ps1"
          & ".\scripts\$tech\run-windows.ps1"

  # ============================================
  # Docker Build Test (all Dockerfiles)
  # ============================================
  test-docker-builds:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    needs: validate-scripts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build all Docker images
        run: |
          set -euo pipefail

          MAX_DOCKERFILES=10
          DOCKERFILE_COUNT=0

          for dockerfile in docker/Dockerfile.*; do
            if [ -f "$dockerfile" ]; then
              ((DOCKERFILE_COUNT++)) || true
              if [ $DOCKERFILE_COUNT -gt $MAX_DOCKERFILES ]; then
                echo "ERROR: Too many Dockerfiles"
                exit 1
              fi

              os_name="${dockerfile##*.}"
              image_name="install-${os_name}"

              echo "Building: ${image_name} from ${dockerfile}"
              docker build -f "$dockerfile" -t "$image_name" .

              echo "Testing: ${image_name}"
              docker run --rm "$image_name" echo "Container started successfully"
            fi
          done

          echo "Built and tested $DOCKERFILE_COUNT Docker images"

  # ============================================
  # Required Status Check (for branch protection)
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [validate-scripts, test-linux, test-macos, test-windows, test-docker-builds]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "========================================="
          echo "CI Status Check for Branch Protection"
          echo "========================================="

          FAILED=0

          if [ "${{ needs.validate-scripts.result }}" != "success" ]; then
            echo "❌ Script validation: ${{ needs.validate-scripts.result }}"
            FAILED=1
          else
            echo "✅ Script validation: passed"
          fi

          if [ "${{ needs.test-linux.result }}" != "success" ]; then
            echo "❌ Linux tests: ${{ needs.test-linux.result }}"
            FAILED=1
          else
            echo "✅ Linux tests: passed"
          fi

          if [ "${{ needs.test-macos.result }}" != "success" ]; then
            echo "❌ macOS tests: ${{ needs.test-macos.result }}"
            FAILED=1
          else
            echo "✅ macOS tests: passed"
          fi

          if [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "❌ Windows tests: ${{ needs.test-windows.result }}"
            FAILED=1
          else
            echo "✅ Windows tests: passed"
          fi

          if [ "${{ needs.test-docker-builds.result }}" != "success" ]; then
            echo "❌ Docker builds: ${{ needs.test-docker-builds.result }}"
            FAILED=1
          else
            echo "✅ Docker builds: passed"
          fi

          echo "========================================="

          if [ $FAILED -eq 1 ]; then
            echo "❌ CI FAILED - Branch protection will block merge"
            exit 1
          fi

          echo "✅ CI PASSED - Ready to merge"
